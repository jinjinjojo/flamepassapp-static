/**
 * AI Chat Page Handler (Fixed V2)
 * Controls access to AI chat based on login status
 */

// Initialize AI chat page handler
function initAIChatHandler() {
  // Check if this is the AI chat page
  if (window.location.pathname !== '/ai.html') return;
  
  // Get the iframe and loading elements
  const aiFrame = document.getElementById('ai-frame');
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingText = document.getElementById('loading-text');
  const refreshButton = document.getElementById('refresh-button');
  
  // If elements don't exist, this isn't the AI chat page
  if (!aiFrame || !loadingOverlay || !loadingText) return;
  
  // Check login status
  const loggedIn = typeof isLoggedIn === 'function' ? isLoggedIn() : false;
  
  if (!loggedIn) {
    // Stop the iframe from loading
    if (aiFrame.src !== 'about:blank') {
      aiFrame.src = 'about:blank';
    }
    
    // Update loading text
    loadingText.textContent = "You must be logged in to use the AI chat.";
    
    // Replace spinner with lock icon
    const spinner = loadingOverlay.querySelector('.spinner');
    if (spinner) {
      const lockIcon = document.createElement('div');
      lockIcon.style.fontSize = '50px';
      lockIcon.style.color = '#de5c34';
      lockIcon.style.marginBottom = '20px';
      lockIcon.innerHTML = '<i class="fa-solid fa-lock"></i>';
      
      // Replace spinner with lock icon
      if (spinner.parentNode) {
        spinner.parentNode.replaceChild(lockIcon, spinner);
      }
    }
    
    // Add a single "Get Started" button
    // First check if a button already exists
    let loginButton = loadingOverlay.querySelector('.login-button');
    
    // If multiple buttons exist, remove all except the first one
    const allButtons = loadingOverlay.querySelectorAll('button');
    if (allButtons.length > 1) {
      for (let i = 1; i < allButtons.length; i++) {
        allButtons[i].parentNode.removeChild(allButtons[i]);
      }
    }
    
    // If no button exists, create one with improved styling
    if (!loginButton) {
      loginButton = document.createElement('button');
      loginButton.textContent = 'Get Started';
      loginButton.className = 'login-button';
      
      // Style the button like on the cheats page with the improved look
      loginButton.style.backgroundColor = '#de5c34';
      loginButton.style.color = 'white';
      loginButton.style.border = 'none';
      loginButton.style.borderRadius = '6px';
      loginButton.style.padding = '10px 20px';
      loginButton.style.fontSize = '16px';
      loginButton.style.fontWeight = 'bold';
      loginButton.style.cursor = 'pointer';
      loginButton.style.marginTop = '20px';
      loginButton.style.transition = 'background-color 0.3s';
      
      // Add hover effect
      loginButton.addEventListener('mouseenter', () => {
        loginButton.style.backgroundColor = '#ff8033';
      });
      
      loginButton.addEventListener('mouseleave', () => {
        loginButton.style.backgroundColor = '#de5c34';
      });
      
      // Add click event
      loginButton.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Show login popup
        if (typeof showLoginPopup === 'function') {
          showLoginPopup();
        } else {
          window.location.href = '/login.html';
        }
      });
      
      loadingOverlay.appendChild(loginButton);
    } else {
      // Update existing button style to match the improved look
      loginButton.textContent = 'Get Started';
      loginButton.style.backgroundColor = '#de5c34';
      loginButton.style.color = 'white';
      loginButton.style.border = 'none';
      loginButton.style.borderRadius = '6px';
      loginButton.style.padding = '10px 20px';
      loginButton.style.fontSize = '16px';
      loginButton.style.fontWeight = 'bold';
      loginButton.style.cursor = 'pointer';
      loginButton.style.marginTop = '20px';
      loginButton.style.transition = 'background-color 0.3s';
      
      // Add hover effect if not already present
      const hasHoverEffect = loginButton.getAttribute('data-has-hover');
      if (!hasHoverEffect) {
        loginButton.setAttribute('data-has-hover', 'true');
        
        loginButton.addEventListener('mouseenter', () => {
          loginButton.style.backgroundColor = '#ff8033';
        });
        
        loginButton.addEventListener('mouseleave', () => {
          loginButton.style.backgroundColor = '#de5c34';
        });
      }
    }
    
    // Disable refresh button
    if (refreshButton) {
      refreshButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Show login popup
        if (typeof showLoginPopup === 'function') {
          showLoginPopup();
        } else {
          window.location.href = '/login.html';
        }
      });
    }
    
    // Make sure the loading overlay is visible
    loadingOverlay.style.display = 'flex';
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initAIChatHandler);

// Also run when window is fully loaded (for dynamic content)
window.addEventListener('load', initAIChatHandler);